# OAuth æˆæ¬Šæµç¨‹åœ–è§£

## ğŸ”„ å®Œæ•´æˆæ¬Šæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ¶è¨ªå• /login                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /auth/login                                                     â”‚
â”‚  â”œâ”€ get_redirect_uri('auth_callback', 'OAUTH_REDIRECT_URI')     â”‚
â”‚  â”‚  â””â”€ è¿”å›: https://pycrm.zeabur.app/auth/callback             â”‚
â”‚  â””â”€ oauth.google.authorize_redirect(request, redirect_uri)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google æˆæ¬Šé é¢                                                 â”‚
â”‚  â”œâ”€ ç”¨æˆ¶é¸æ“‡å¸³è™Ÿ                                                â”‚
â”‚  â”œâ”€ æˆæ¬Š openid email profile                                   â”‚
â”‚  â””â”€ é‡å®šå‘å›æ‡‰ç”¨ (å¸¶è‘— code å’Œ state)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /auth/callback?code=xxx&state=yyy                              â”‚
â”‚  â”œâ”€ get_redirect_uri('auth_callback', 'OAUTH_REDIRECT_URI')     â”‚
â”‚  â”‚  â””â”€ è¿”å›: https://pycrm.zeabur.app/auth/callback (ç›¸åŒ!)     â”‚
â”‚  â”œâ”€ oauth.google.authorize_access_token(request, redirect_uri)  â”‚
â”‚  â”‚  â”œâ”€ é©—è­‰ state åƒæ•¸ âœ…                                       â”‚
â”‚  â”‚  â””â”€ äº¤æ› code å–å¾— access_token                             â”‚
â”‚  â”œâ”€ å„²å­˜ user è³‡è¨Šåˆ° session['user']                           â”‚
â”‚  â””â”€ é‡å®šå‘åˆ° /dashboard                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶å·²ç™»å…¥ï¼å¯ä»¥è¨ªå•æ‰€æœ‰é é¢                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“§ Gmail API æˆæ¬Šæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶è¨ªå• /send-email (å·²ç™»å…¥ç‹€æ…‹)                              â”‚
â”‚  â””â”€ æª¢æŸ¥: session['gmail_token'] ä¸å­˜åœ¨                         â”‚
â”‚     â””â”€ é¡¯ç¤ºã€Œéœ€è¦æˆæ¬Š Gmail APIã€æŒ‰éˆ•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é»æ“Šã€Œæˆæ¬Š Gmail APIã€æŒ‰éˆ•                                      â”‚
â”‚  â””â”€ window.location.href = '/auth/gmail/login'                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /auth/gmail/login                                               â”‚
â”‚  â”œâ”€ get_redirect_uri('gmail_auth_callback',                     â”‚
â”‚  â”‚                    'GMAIL_OAUTH_REDIRECT_URI')               â”‚
â”‚  â”‚  â””â”€ è¿”å›: https://pycrm.zeabur.app/auth/gmail/callback       â”‚
â”‚  â””â”€ oauth.google_gmail.authorize_redirect(                      â”‚
â”‚         request, redirect_uri,                                   â”‚
â”‚         access_type='offline', prompt='consent')                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google æˆæ¬Šé é¢                                                 â”‚
â”‚  â”œâ”€ é¡¯ç¤ºéœ€è¦çš„æ¬Šé™ï¼š                                            â”‚
â”‚  â”‚  â”œâ”€ æŸ¥çœ‹ä½ çš„ email                                          â”‚
â”‚  â”‚  â”œâ”€ æŸ¥çœ‹ä½ çš„å€‹äººè³‡è¨Š                                        â”‚
â”‚  â”‚  â””â”€ â­ ä»¥ä½ çš„èº«ä»½å‚³é€é›»å­éƒµä»¶ (gmail.send)                  â”‚
â”‚  â”œâ”€ ç”¨æˆ¶é»æ“Šã€Œå…è¨±ã€                                            â”‚
â”‚  â””â”€ é‡å®šå‘å›æ‡‰ç”¨ (å¸¶è‘— code å’Œ state)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /auth/gmail/callback?code=xxx&state=yyy                        â”‚
â”‚  â”œâ”€ get_redirect_uri('gmail_auth_callback',                     â”‚
â”‚  â”‚                    'GMAIL_OAUTH_REDIRECT_URI')               â”‚
â”‚  â”‚  â””â”€ è¿”å›: https://pycrm.zeabur.app/auth/gmail/callback       â”‚
â”‚  â”œâ”€ oauth.google_gmail.authorize_access_token(                  â”‚
â”‚  â”‚     request, redirect_uri)                                   â”‚
â”‚  â”‚  â”œâ”€ é©—è­‰ state åƒæ•¸ âœ…                                       â”‚
â”‚  â”‚  â””â”€ äº¤æ› code å–å¾— access_token + refresh_token             â”‚
â”‚  â”œâ”€ å„²å­˜ token åˆ° session['gmail_token']                        â”‚
â”‚  â”‚  â”œâ”€ access_token                                             â”‚
â”‚  â”‚  â”œâ”€ refresh_token                                            â”‚
â”‚  â”‚  â”œâ”€ token_type                                               â”‚
â”‚  â”‚  â””â”€ expires_in                                               â”‚
â”‚  â””â”€ é¡¯ç¤ºæˆåŠŸé é¢ï¼Œ2ç§’å¾Œè·³è½‰åˆ° /send-email                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /send-email                                                     â”‚
â”‚  â””â”€ æª¢æŸ¥: session['gmail_token'] å­˜åœ¨ âœ…                        â”‚
â”‚     â””â”€ é¡¯ç¤ºã€ŒGmail API å·²æˆæ¬Šã€                                â”‚
â”‚     â””â”€ å¯ä»¥ç™¼é€éƒµä»¶ï¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Session è³‡æ–™çµæ§‹

```python
request.session = {
    # ç”¨æˆ¶ç™»å…¥è³‡è¨Š
    'user': {
        'email': 'user@gmail.com',
        'name': 'å¼µä¸‰',
        'picture': 'https://...',
        'sub': 'google_user_id'
    },
    
    # Gmail API Tokenï¼ˆç¨ç«‹å„²å­˜ï¼‰
    'gmail_token': {
        'access_token': 'ya29.a0...',
        'refresh_token': '1//0g...',
        'token_type': 'Bearer',
        'expires_in': 3599
    },
    
    # Session metadata
    '_id': 'session_identifier',
    # OAuth state (ç”± authlib ç®¡ç†)
    '_state_google_...' : {...},
    '_state_google_gmail_...' : {...}
}
```

---

## âš™ï¸ é—œéµé…ç½®é»

### 1. SessionMiddleware é…ç½®
```python
app.add_middleware(
    SessionMiddleware,
    secret_key=os.getenv("SECRET_KEY"),      # ç”¨æ–¼åŠ å¯† session
    session_cookie="session",                 # Cookie åç¨±
    max_age=3600,                            # 1 å°æ™‚éæœŸ
    same_site="lax",                         # â­ é—œéµï¼šå…è¨± OAuth redirect
    https_only=False                          # é–‹ç™¼ç’°å¢ƒç”¨
)
```

### 2. OAuth é…ç½® - å…©å€‹ç¨ç«‹çš„å®¢æˆ¶ç«¯
```python
# ç™»å…¥ç”¨
oauth.register(
    name='google',
    scope='openid email profile'
)

# Gmail API ç”¨
oauth.register(
    name='google_gmail',
    scope='openid email profile https://www.googleapis.com/auth/gmail.send'
)
```

### 3. redirect_uri ç”Ÿæˆé‚è¼¯
```python
def get_redirect_uri(request, callback_name, env_var=None):
    # 1. å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸
    if env_var and os.getenv(env_var):
        return os.getenv(env_var)
    
    # 2. è‡ªå‹•ç”Ÿæˆ
    uri = str(request.url_for(callback_name))
    
    # 3. Zeabur ä¿®æ­£ï¼šhttp â†’ https
    if 'zeabur.app' in str(request.base_url):
        uri = uri.replace('http://', 'https://')
    
    return uri
```

---

## ğŸ› å¸¸è¦‹éŒ¯èª¤æµç¨‹

### éŒ¯èª¤ 1: redirect_uri ä¸ä¸€è‡´

```
âŒ éŒ¯èª¤æµç¨‹ï¼š

/auth/gmail/login
  â”œâ”€ redirect_uri: https://pycrm.zeabur.app/auth/gmail/callback
  â””â”€ authlib å„²å­˜ state + redirect_uri

Google æˆæ¬Šä¸¦è¿”å›

/auth/gmail/callback
  â”œâ”€ æ²’æœ‰æ˜ç¢ºå‚³é redirect_uri
  â”œâ”€ authlib è‡ªå‹•æª¢æ¸¬ â†’ http://pycrm.zeabur.app/auth/gmail/callback
  â””â”€ âŒ redirect_uri ä¸ä¸€è‡´ â†’ state é©—è­‰å¤±æ•—
```

### éŒ¯èª¤ 2: Session cookie è¨­å®šéŒ¯èª¤

```
âŒ éŒ¯èª¤ï¼šsame_site="strict"

/auth/gmail/login
  â””â”€ è¨­ç½® session['_state_...'] = {...}

â†’ Google æˆæ¬Šé é¢

/auth/gmail/callback
  â”œâ”€ Cookie è¢«ç€è¦½å™¨é˜»æ“‹ï¼ˆå› ç‚º same_site=strictï¼‰
  â”œâ”€ è®€å–ä¸åˆ° session['_state_...']
  â””â”€ âŒ state é©—è­‰å¤±æ•—
```

---

## âœ… æ­£ç¢ºæµç¨‹ç¸½çµ

```
ç™»å…¥æµç¨‹ï¼š
  user â†’ /auth/login â†’ Google â†’ /auth/callback â†’ session['user'] âœ…
                                                         â†“
Gmail æˆæ¬Šï¼š                                              â†“
  user â†’ /auth/gmail/login â†’ Google â†’ /auth/gmail/callback â†’ session['gmail_token'] âœ…
                                                                        â†“
ç™¼é€éƒµä»¶ï¼š                                                              â†“
  user â†’ /send-email â†’ ä½¿ç”¨ session['gmail_token'] â†’ ç™¼é€æˆåŠŸ âœ…
```

---

## ğŸ¯ é—œéµæˆåŠŸå› ç´ 

1. âœ… **ç›¸åŒçš„ redirect_uri ç”Ÿæˆé‚è¼¯** - ä½¿ç”¨ `get_redirect_uri()` å‡½æ•¸
2. âœ… **æ˜ç¢ºå‚³é redirect_uri** - åœ¨ `authorize_access_token()` æ™‚
3. âœ… **æ­£ç¢ºçš„ session é…ç½®** - `same_site="lax"`
4. âœ… **HTTPS ä¿®æ­£** - Zeabur ç’°å¢ƒè‡ªå‹•è½‰æ›
5. âœ… **åˆ†é›¢çš„ OAuth é…ç½®** - ç™»å…¥å’Œ Gmail API ç¨ç«‹
