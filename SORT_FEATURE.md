# 📅 客戶排序功能說明

## ✨ 新功能

已為 CRM 系統加入 **智能排序功能**，客戶列表自動按最後修改時間排序。

## 🎯 排序規則

### 優先順序
1. **有更新記錄** → 按 `updated_at` 降序（最新修改的排最前面）
2. **無更新記錄** → 按 `created_at` 降序（最新建立的排最前面）

### 排序邏輯
```sql
ORDER BY 
  updated_at DESC NULLS LAST,
  created_at DESC
```

## 📊 排序示例

### 場景：多筆客戶資料

| ID | 客戶名稱 | 建立時間 | 最後修改時間 | 排序位置 |
|----|---------|---------|-------------|---------|
| 3  | 晨曦文創 | 14:28:26 | **14:45:13** | 1 ⭐ 最新 |
| 5  | 恆星教育 | 14:28:26 | **14:44:43** | 2 |
| 1  | 宏達數位 | 14:28:26 | **14:43:56** | 3 |
| 2  | 綠能科技 | 14:28:26 | **14:42:35** | 4 |
| 10 | 豐收農業 | 14:28:26 | *未修改* | 5 |
| 9  | 捷思設計 | 14:28:26 | *未修改* | 6 |

**說明：**
- ID 3 最近被修改 → 排第一位
- ID 5, 1, 2 按修改時間降序排列
- ID 10, 9 沒有修改記錄 → 按建立時間排序

## 🎨 視覺標示

### Dashboard 顯示

#### 列表標題
```
┌─────────────────────────────────────────┐
│ 客戶列表    📅 排序：最後修改時間（新→舊）│
└─────────────────────────────────────────┘
```

#### 時間欄位
- **已更新**：顯示綠色「已更新」標記 + 修改時間
  ```
  [已更新] 02/08 14:45
  ```

- **未更新**：顯示灰色建立時間
  ```
  02/08 14:28
  ```

## 💡 使用情境

### 情境 A：找最近編輯的客戶
> 剛剛更新了某個客戶的資料，想快速找到它

**優勢：**
- 最新修改的自動排在最前面
- 不需搜尋，直接在列表頂部

### 情境 B：查看最近的工作記錄
> 想知道最近處理了哪些客戶

**方法：**
1. 打開 Dashboard
2. 查看有「已更新」標記的客戶
3. 這些就是最近編輯過的記錄

### 情境 C：新建客戶立即可見
> 剛新增一個客戶，想確認是否成功

**行為：**
- 新建的客戶會出現在未修改區塊的最上方
- 如果沒有其他更新記錄，會直接排第一

## 🔍 技術細節

### 後端實作（SQLAlchemy）
```python
query = query.order_by(
    models.Client.updated_at.desc().nullslast(),
    models.Client.created_at.desc()
)
```

**解說：**
1. `updated_at.desc()` - 修改時間降序
2. `.nullslast()` - NULL 值排最後
3. `created_at.desc()` - 建立時間降序（次要排序）

### 前端顯示（Jinja2）
```jinja2
{% if client.updated_at %}
    <span class="updated-badge">已更新</span>
    <small>{{ client.updated_at.strftime('%m/%d %H:%M') }}</small>
{% else %}
    <small class="created-time">{{ client.created_at.strftime('%m/%d %H:%M') }}</small>
{% endif %}
```

## 🧪 測試驗證

### 執行測試腳本
```bash
./test_sort.sh
```

### 測試項目
- ✅ 最新修改的客戶排第一
- ✅ 修改時間降序排列
- ✅ 未修改的按建立時間排序
- ✅ Dashboard 顯示排序說明
- ✅ 時間標記正確顯示

### 手動測試步驟
```bash
# 1. 查看當前排序
curl http://localhost:8000/api/clients/ | jq '.[0:3]'

# 2. 更新一筆資料
curl -X PUT http://localhost:8000/api/clients/3 \
  -H "Content-Type: application/json" \
  -d '{"project_cost": 150000}'

# 3. 再次查看排序（ID 3 應該排第一）
curl http://localhost:8000/api/clients/ | jq '.[0:3]'
```

## 📱 響應式設計

### 桌面版
```
ID | 客戶 | 專案 | Email | 費用 | 最後修改 | 操作
---|------|------|-------|------|---------|-----
```

### 手機版
- 時間欄位文字變小
- 「已更新」標記保持可見
- 表格可左右滑動

## 🎯 與其他功能整合

### 搜尋功能
- 搜尋結果**仍然按修改時間排序**
- 可以找到符合條件且最近修改的記錄

### CSV 匯入
- 匯入的資料 `updated_at = NULL`
- 會按 `created_at` 排在已修改記錄之後

## 📊 效能考量

### 資料庫索引
建議在資料庫添加索引以提升查詢效能：

```sql
CREATE INDEX idx_clients_updated_at ON clients(updated_at DESC NULLS LAST);
CREATE INDEX idx_clients_created_at ON clients(created_at DESC);
```

### 查詢效率
- 使用資料庫層級排序（不是 Python 排序）
- 支援分頁，不影響大量資料查詢
- 單次查詢完成，無額外 API 請求

## 🔄 未來擴展

### 可能的優化方向
1. **自訂排序**：允許用戶選擇排序方式
   - 按客戶名稱
   - 按專案費用
   - 按建立時間
   - 按修改時間（預設）

2. **排序方向切換**：點擊表頭切換升序/降序

3. **多欄位排序**：先按費用，再按時間等

## 📝 修改的檔案

```
✅ app/crud.py                      - 添加排序邏輯
✅ app/templates/dashboard.html     - 添加時間欄位和排序說明
✅ app/static/css/custom.css        - 時間標記樣式
✅ test_sort.sh                     - 排序功能測試腳本
```

## 🚀 立即體驗

```bash
# 訪問 Dashboard
http://localhost:8000/dashboard

# 編輯任一客戶，觀察排序變化
http://localhost:8000/client/1/edit
```

## ✅ 功能檢查清單

- [x] 修改時間降序排列
- [x] 未修改記錄按建立時間排序
- [x] Dashboard 顯示排序說明
- [x] 時間欄位顯示正確
- [x] 「已更新」標記樣式美觀
- [x] 搜尋結果保持排序
- [x] 測試腳本通過
- [x] 響應式設計正常

---

**排序功能已上線並正常運作！** 🎉
