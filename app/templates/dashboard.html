{% extends "base.html" %}

{% block title %}Dashboard - CRM å°ˆæ¡ˆç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>å°ˆæ¡ˆç®¡ç† Dashboard</h1>
    
    <!-- çµ±è¨ˆé¢æ¿ -->
    <div class="pure-g stats-panel">
        <div class="pure-u-1 pure-u-md-1-3">
            <div class="stat-card">
                <h3>ç¸½å®¢æˆ¶æ•¸</h3>
                <p class="stat-number">{{ stats.total_clients }}</p>
            </div>
        </div>
        <div class="pure-u-1 pure-u-md-1-3">
            <div class="stat-card">
                <h3>ç¸½å°ˆæ¡ˆé‡‘é¡</h3>
                <p class="stat-number">NT$ {{ "{:,}".format(stats.total_amount) }}</p>
            </div>
        </div>
        <div class="pure-u-1 pure-u-md-1-3">
            <div class="stat-card">
                <h3>å¹³å‡å°ˆæ¡ˆé‡‘é¡</h3>
                <p class="stat-number">NT$ {{ "{:,}".format(stats.average_amount) }}</p>
            </div>
        </div>
    </div>

    <!-- æœå°‹è¡¨å–® -->
    <div class="search-section">
        <form class="pure-form" method="get" action="/dashboard">
            <fieldset>
                <input type="text" name="search" placeholder="æœå°‹å®¢æˆ¶æˆ–å°ˆæ¡ˆ..." value="{{ search }}" class="pure-input-1-2">
                <button type="submit" class="pure-button pure-button-primary">æœå°‹</button>
                {% if search %}
                <a href="/dashboard" class="pure-button">æ¸…é™¤</a>
                {% endif %}
                <a href="/send-email" class="pure-button button-success" style="float: right;">ğŸ“§ ç™¼é€éƒµä»¶</a>
                <a href="/email-logs" class="pure-button" style="float: right; margin-right: 10px;">ğŸ“¬ ç™¼é€è¨˜éŒ„</a>
            </fieldset>
        </form>
    </div>

    <!-- å®¢æˆ¶åˆ—è¡¨ -->
    <div class="client-list">
        <div class="list-header">
            <h2>å®¢æˆ¶åˆ—è¡¨</h2>
            <span class="sort-info">ğŸ“… æ’åºï¼šæœ€å¾Œä¿®æ”¹æ™‚é–“ï¼ˆæ–°â†’èˆŠï¼‰</span>
        </div>
        {% if clients %}
        <table class="pure-table pure-table-bordered pure-table-striped" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å®¢æˆ¶åç¨±</th>
                    <th>å°ˆæ¡ˆåç¨±</th>
                    <th>Email</th>
                    <th>å°ˆæ¡ˆè²»ç”¨</th>
                    <th>æœ€å¾Œä¿®æ”¹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr>
                    <td>{{ client.id }}</td>
                    <td>{{ client.client_name }}</td>
                    <td>{{ client.project_name }}</td>
                    <td class="email-cell" data-email="{{ client.email }}">
                        <span class="masked-email"></span>
                        <button class="pure-button button-small toggle-email" onclick="toggleEmail(this)">é¡¯ç¤º</button>
                    </td>
                    <td>NT$ {{ "{:,}".format(client.project_cost) }}</td>
                    <td class="time-cell">
                        {% if client.updated_at %}
                        <span class="updated-badge">å·²æ›´æ–°</span>
                        <small>{{ client.updated_at.strftime('%m/%d %H:%M') }}</small>
                        {% else %}
                        <small class="created-time">{{ client.created_at.strftime('%m/%d %H:%M') }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/client/{{ client.id }}/edit" class="pure-button pure-button-primary button-small">ç·¨è¼¯</a>
                        <button onclick="deleteClient({{ client.id }})" class="pure-button button-error button-small">åˆªé™¤</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">ç›®å‰æ²’æœ‰å®¢æˆ¶è³‡æ–™</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Email é®ç½©å‡½æ•¸
function maskEmail(email) {
    const [localPart, domain] = email.split('@');
    if (localPart.length <= 3) {
        return localPart[0] + '***@' + domain;
    }
    const visibleStart = localPart.substring(0, 3);
    return visibleStart + '***@' + domain;
}

// åˆå§‹åŒ–æ‰€æœ‰ email é®ç½©
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.email-cell').forEach(cell => {
        const email = cell.getAttribute('data-email');
        const maskedSpan = cell.querySelector('.masked-email');
        maskedSpan.textContent = maskEmail(email);
    });
});

// åˆ‡æ›é¡¯ç¤º/éš±è— email
function toggleEmail(button) {
    const cell = button.closest('.email-cell');
    const email = cell.getAttribute('data-email');
    const maskedSpan = cell.querySelector('.masked-email');
    
    if (button.textContent === 'é¡¯ç¤º') {
        maskedSpan.textContent = email;
        button.textContent = 'éš±è—';
        button.classList.add('button-active');
    } else {
        maskedSpan.textContent = maskEmail(email);
        button.textContent = 'é¡¯ç¤º';
        button.classList.remove('button-active');
    }
}

function deleteClient(clientId) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿ')) {
        fetch(`/api/clients/${clientId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(error => {
            alert('åˆªé™¤å¤±æ•—ï¼š' + error);
        });
    }
}
</script>
{% endblock %}
