{% extends "base.html" %}

{% block title %}æ—¥å¹£åŒ¯ç‡æŸ¥è©¢ - CRM å°ˆæ¡ˆç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>ğŸ’´ æ—¥å¹£åŒ¯ç‡æŸ¥è©¢</h1>

    <!-- æœ€æ–°åŒ¯ç‡ + æ‰‹å‹•çˆ¬å– -->
    <div class="pure-g stats-panel">
        <div class="pure-u-1 pure-u-md-1-2">
            <div class="stat-card" style="border-left: 4px solid #e74c3c;">
                <h3>æœ€æ–°æ—¥å¹£ç¾é‡‘è³£å‡ºåŒ¯ç‡</h3>
                {% if latest %}
                <p class="stat-number" style="color: #e74c3c;">{{ latest.cash_selling }}</p>
                <small style="color: #888;">
                    ğŸ“… {{ latest.rate_date.strftime('%Y/%m/%d') }} {{ 'ğŸŒ… æ—©ä¸Š' if latest.period == 'morning' else 'ğŸŒ™ æ™šä¸Š'
                    }}
                    ãƒ»æ›´æ–°æ™‚é–“ {{ latest.fetched_at | to_taipei("%H:%M") }}
                </small>
                {% else %}
                <p class="stat-number" style="color: #999;">å°šç„¡è³‡æ–™</p>
                {% endif %}
            </div>
        </div>
        <div class="pure-u-1 pure-u-md-1-2">
            <div class="stat-card"
                style="text-align: center; display: flex; flex-direction: column; justify-content: center;">
                <h3>æ‰‹å‹•çˆ¬å–</h3>
                <button id="fetchBtn" onclick="fetchRate()" class="pure-button pure-button-primary"
                    style="font-size: 1.1em; padding: 10px 30px;">
                    ğŸ”„ ç«‹å³çˆ¬å–æœ€æ–°åŒ¯ç‡
                </button>
                <small id="fetchStatus" style="margin-top: 10px; color: #888;"></small>
            </div>
        </div>
    </div>

    <!-- åŒ¯ç‡èµ°å‹¢åœ– -->
    {% if chart_dates %}
    <div class="client-list" style="margin-top: 20px;">
        <h2>ğŸ“ˆ åŒ¯ç‡èµ°å‹¢ï¼ˆè¿‘ 90 å¤©ï¼‰</h2>
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
            <canvas id="rateChart" height="100"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- æ­·å²åŒ¯ç‡è¡¨æ ¼ -->
    <div class="client-list" style="margin-top: 20px;">
        <h2>ğŸ“‹ æ­·å²åŒ¯ç‡è¨˜éŒ„</h2>
        {% if history %}
        <table class="pure-table pure-table-bordered pure-table-striped" style="width: 100%;">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ™‚æ®µ</th>
                    <th>ç¾é‡‘è³£å‡ºåŒ¯ç‡</th>
                    <th>çˆ¬å–æ™‚é–“</th>
                </tr>
            </thead>
            <tbody>
                {% for record in history %}
                <tr>
                    <td>{{ record.rate_date.strftime('%Y/%m/%d') }}</td>
                    <td>{{ 'ğŸŒ… æ—©ä¸Š' if record.period == 'morning' else 'ğŸŒ™ æ™šä¸Š' }}</td>
                    <td style="font-weight: bold; color: #e74c3c;">{{ record.cash_selling }}</td>
                    <td><small>{{ record.fetched_at | to_taipei }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">ç›®å‰æ²’æœ‰åŒ¯ç‡è³‡æ–™ï¼Œè«‹é»æ“Šã€Œç«‹å³çˆ¬å–ã€æŒ‰éˆ•å–å¾—æœ€æ–°åŒ¯ç‡ã€‚</p>
        {% endif %}
    </div>

    <div style="margin-top: 15px;">
        <small style="color: #999;">
            ğŸ“Œ è³‡æ–™ä¾†æºï¼š<a href="https://rate.bot.com.tw/xrt?Lang=zh-TW" target="_blank">è‡ºç£éŠ€è¡Œç‰Œå‘ŠåŒ¯ç‡</a>
            ãƒ»è‡ªå‹•æ’ç¨‹ï¼šæ¯æ—¥ 08:00 / 20:00 å„çˆ¬å–ä¸€æ¬¡
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if chart_dates %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const ctx = document.getElementById('rateChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_dates | tojson }},
        datasets: [{
            label: 'JPY ç¾é‡‘è³£å‡ºåŒ¯ç‡',
            data: {{ chart_values | tojson }},
        borderColor: '#e74c3c',
        backgroundColor: 'rgba(231, 76, 60, 0.08)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 6,
        borderWidth: 2,
        }]
    },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: ctx => `åŒ¯ç‡: ${ctx.parsed.y}`
                }
            }
        },
        scales: {
            y: {
                title: { display: true, text: 'åŒ¯ç‡ (TWD)' },
            },
            x: {
                title: { display: true, text: 'æ—¥æœŸ' },
            }
        }
    }
});
</script>
{% endif %}

<script>
    async function fetchRate() {
        const btn = document.getElementById('fetchBtn');
        const status = document.getElementById('fetchStatus');
        btn.disabled = true;
        btn.textContent = 'â³ çˆ¬å–ä¸­...';
        status.textContent = '';

        try {
            const resp = await fetch('/api/exchange-rate/fetch', { method: 'POST' });
            const data = await resp.json();
            if (data.success) {
                status.textContent = `âœ… çˆ¬å–æˆåŠŸï¼åŒ¯ç‡: ${data.rate}ï¼ˆ${data.date}ï¼‰`;
                status.style.color = '#27ae60';
                setTimeout(() => location.reload(), 1500);
            } else {
                status.textContent = `âŒ çˆ¬å–å¤±æ•—: ${data.error}`;
                status.style.color = '#e74c3c';
            }
        } catch (e) {
            status.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${e.message}`;
            status.style.color = '#e74c3c';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ ç«‹å³çˆ¬å–æœ€æ–°åŒ¯ç‡';
        }
    }
</script>
{% endblock %}