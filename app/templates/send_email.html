{% extends "base.html" %}

{% block title %}ç™¼é€éƒµä»¶ - CRM ç³»çµ±{% endblock %}

{% block content %}
<div class="email-send-page">
    <h1>ğŸ“§ ç™¼é€éƒµä»¶çµ¦å®¢æˆ¶</h1>
    
    <!-- Gmail æˆæ¬Šç‹€æ…‹ -->
    {% if not is_gmail_auth %}
    <div class="alert alert-warning">
        <h4>âš ï¸ éœ€è¦ Gmail API æˆæ¬Š</h4>
        <p>é¦–æ¬¡ä½¿ç”¨éœ€è¦æˆæ¬Š Gmail API æ‰èƒ½ç™¼é€éƒµä»¶ã€‚</p>
        <button type="button" class="pure-button pure-button-primary" onclick="authorizeGmail()">
            ğŸ” æˆæ¬Š Gmail API
        </button>
    </div>
    {% else %}
    <div class="alert alert-success">
        <span>âœ… Gmail API å·²æˆæ¬Šï¼Œå¯ä»¥ç™¼é€éƒµä»¶</span>
    </div>
    {% endif %}
    
    <form id="emailForm" class="pure-form pure-form-stacked"{% if not is_gmail_auth %} style="opacity: 0.5; pointer-events: none;"{% endif %}>
        <!-- é¸æ“‡éƒµä»¶æ¨¡æ¿ -->
        <fieldset>
            <legend>1. é¸æ“‡éƒµä»¶æ¨¡æ¿</legend>
            <div class="template-selection">
                {% for template in templates %}
                <label class="template-card">
                    <input type="radio" name="template" value="{{ template.id }}" required>
                    <div class="template-info">
                        <h3>{{ template.name }}</h3>
                        <p class="template-type">é¡å‹ï¼š
                            {% if template.template_type == 'invoice' %}
                            ğŸ’° è«‹æ¬¾å–®
                            {% elif template.template_type == 'greeting' %}
                            ğŸ‰ ç¯€æ—¥å•å€™
                            {% elif template.template_type == 'promotion' %}
                            ğŸ ä¿ƒéŠ·å„ªæƒ 
                            {% endif %}
                        </p>
                        <p class="template-subject"><strong>ä¸»æ—¨ï¼š</strong>{{ template.subject }}</p>
                    </div>
                </label>
                {% endfor %}
            </div>
        </fieldset>

        <!-- é¸æ“‡æ”¶ä»¶å®¢æˆ¶ -->
        <fieldset>
            <legend>2. é¸æ“‡æ”¶ä»¶å®¢æˆ¶</legend>
            <div class="client-selection">
                <div class="selection-controls">
                    <button type="button" class="pure-button" onclick="selectAll()">å…¨é¸</button>
                    <button type="button" class="pure-button" onclick="deselectAll()">å–æ¶ˆå…¨é¸</button>
                    <span id="selectedCount" class="selected-count">å·²é¸æ“‡ï¼š0 ä½å®¢æˆ¶</span>
                </div>
                
                <div class="client-list-grid">
                    {% for client in clients %}
                    <label class="client-card">
                        <input type="checkbox" name="clients" value="{{ client.id }}" onchange="updateCount()">
                        <div class="client-info">
                            <h4>{{ client.client_name }}</h4>
                            <p>ğŸ“§ {{ client.email }}</p>
                            <p>ğŸ“ {{ client.project_name }}</p>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </fieldset>

        <!-- é è¦½èˆ‡ç™¼é€ -->
        <fieldset>
            <legend>3. ç¢ºèªèˆ‡ç™¼é€</legend>
            <button type="button" class="pure-button pure-button-primary" onclick="previewEmail()">
                ğŸ‘ï¸ é è¦½éƒµä»¶
            </button>
            <button type="submit" class="pure-button button-success" id="sendButton">
                ğŸ“¤ ç™¼é€éƒµä»¶
            </button>
            <a href="/dashboard" class="pure-button">å–æ¶ˆ</a>
        </fieldset>
    </form>

    <!-- é è¦½æ¨¡æ…‹æ¡† -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreview()">&times;</span>
            <h2>éƒµä»¶é è¦½</h2>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- ç™¼é€çµæœæ¨¡æ…‹æ¡† -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResult()">&times;</span>
            <h2>ç™¼é€çµæœ</h2>
            <div id="resultContent"></div>
        </div>
    </div>
</div>

<style>
.email-send-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.template-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.template-card {
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    display: block;
}

.template-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
}

.template-card input[type="radio"] {
    display: none;
}

.template-card input[type="radio"]:checked + .template-info {
    background: #f0f4ff;
}

.template-info {
    padding: 10px;
    border-radius: 5px;
}

.template-type {
    color: #666;
    font-size: 14px;
}

.template-subject {
    color: #333;
    font-size: 14px;
}

.client-selection {
    margin: 15px 0;
}

.selection-controls {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.selected-count {
    font-weight: bold;
    color: #667eea;
}

.client-list-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.client-card {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    display: block;
}

.client-card:hover {
    border-color: #4CAF50;
}

.client-card input[type="checkbox"]:checked {
    accent-color: #4CAF50;
}

.client-card input[type="checkbox"]:checked ~ .client-info {
    background: #f0fff4;
}

.client-info h4 {
    margin: 0 0 8px 0;
    color: #333;
}

.client-info p {
    margin: 4px 0;
    font-size: 13px;
    color: #666;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 10px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
}

.button-success {
    background-color: #4CAF50;
    color: white;
}

.button-success:hover {
    background-color: #45a049;
}

fieldset {
    margin-bottom: 30px;
    border: 2px solid #667eea;
    border-radius: 10px;
}

legend {
    font-weight: bold;
    color: #667eea;
    padding: 0 10px;
}

.alert {
    padding: 1.5em;
    border-radius: 8px;
    margin-bottom: 2em;
}

.alert-warning {
    background: #fff3cd;
    border: 2px solid #ffc107;
    color: #856404;
}

.alert-success {
    background: #d4edda;
    border: 2px solid #28a745;
    color: #155724;
}

.alert h4 {
    margin-top: 0;
}
</style>

<script>
let gmailAuthWindow = null;

// Gmail æˆæ¬Š
function authorizeGmail() {
    fetch('/gmail/auth-url')
        .then(response => response.json())
        .then(data => {
            // é–‹å•Ÿæ–°è¦–çª—é€²è¡Œæˆæ¬Š
            gmailAuthWindow = window.open(
                data.auth_url,
                'Gmail æˆæ¬Š',
                'width=600,height=700'
            );
        })
        .catch(error => {
            alert('å–å¾—æˆæ¬Š URL å¤±æ•—ï¼š' + error);
        });
}

// ç›£è½æˆæ¬Šå®Œæˆè¨Šæ¯
window.addEventListener('message', function(event) {
    if (event.data === 'gmail_auth_success') {
        location.reload();
    }
});

function updateCount() {
    const checked = document.querySelectorAll('input[name="clients"]:checked').length;
    document.getElementById('selectedCount').textContent = `å·²é¸æ“‡ï¼š${checked} ä½å®¢æˆ¶`;
}

function selectAll() {
    document.querySelectorAll('input[name="clients"]').forEach(cb => cb.checked = true);
    updateCount();
}

function deselectAll() {
    document.querySelectorAll('input[name="clients"]').forEach(cb => cb.checked = false);
    updateCount();
}

function previewEmail() {
    const templateId = document.querySelector('input[name="template"]:checked')?.value;
    if (!templateId) {
        alert('è«‹å…ˆé¸æ“‡éƒµä»¶æ¨¡æ¿');
        return;
    }
    
    const template = {{ templates | tojson }}.find(t => t.id == templateId);
    const previewHtml = `
        <h3>ä¸»æ—¨ï¼š${template.subject}</h3>
        <hr>
        ${template.content.replace(/\{\{(\w+)\}\}/g, '<span style="background: yellow;">[$1]</span>')}
    `;
    
    document.getElementById('previewContent').innerHTML = previewHtml;
    document.getElementById('previewModal').style.display = 'block';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

function closeResult() {
    document.getElementById('resultModal').style.display = 'none';
    location.reload();
}

document.getElementById('emailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const templateId = document.querySelector('input[name="template"]:checked')?.value;
    const clientIds = Array.from(document.querySelectorAll('input[name="clients"]:checked'))
        .map(cb => parseInt(cb.value));
    
    if (!templateId) {
        alert('è«‹é¸æ“‡éƒµä»¶æ¨¡æ¿');
        return;
    }
    
    if (clientIds.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½å®¢æˆ¶');
        return;
    }
    
    if (!confirm(`ç¢ºå®šè¦ç™¼é€éƒµä»¶çµ¦ ${clientIds.length} ä½å®¢æˆ¶å—ï¼Ÿ`)) {
        return;
    }
    
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.textContent = 'ç™¼é€ä¸­...';
    
    try {
        const response = await fetch('/api/emails/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                template_id: parseInt(templateId),
                client_ids: clientIds
            })
        });
        
        const result = await response.json();
        
        let resultHtml = `
            <h3>âœ… ç™¼é€å®Œæˆ</h3>
            <p>ç¸½è¨ˆï¼š${result.total} å°</p>
            <p style="color: green;">æˆåŠŸï¼š${result.success_count} å°</p>
            <p style="color: red;">å¤±æ•—ï¼š${result.failed_count} å°</p>
            <hr>
            <h4>è©³ç´°çµæœï¼š</h4>
            <ul>
        `;
        
        result.results.forEach(r => {
            const icon = r.success ? 'âœ…' : 'âŒ';
            const status = r.success ? 'æˆåŠŸ' : `å¤±æ•— (${r.error})`;
            resultHtml += `<li>${icon} ${r.client_name} (${r.email}) - ${status}</li>`;
        });
        
        resultHtml += '</ul>';
        
        document.getElementById('resultContent').innerHTML = resultHtml;
        document.getElementById('resultModal').style.display = 'block';
        
    } catch (error) {
        alert('ç™¼é€å¤±æ•—ï¼š' + error.message);
    } finally {
        sendButton.disabled = false;
        sendButton.textContent = 'ğŸ“¤ ç™¼é€éƒµä»¶';
    }
});

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
window.onclick = function(event) {
    const previewModal = document.getElementById('previewModal');
    const resultModal = document.getElementById('resultModal');
    if (event.target == previewModal) {
        previewModal.style.display = 'none';
    }
    if (event.target == resultModal) {
        resultModal.style.display = 'none';
    }
}
</script>
{% endblock %}
